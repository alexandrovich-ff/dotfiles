#!/bin/sh

# vim: filetype=i3blocks
#   ____ ____  _   _ 
#  / ___|  _ \| | | |
# | |   | |_) | | | |
# | |___|  __/| |_| |
#  \____|_|    \___/ 
#
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€
# ÐÐ°Ð¿Ð¸ÑÐ°Ð½: @alexandrovich.ff
# Website: http://malikov.red

case $BLOCK_BUTTON in
	1) notify-send "ðŸ–¥CPU Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹" "$(ps axch -o cmd:15,%cpu --sort=-%cpu | head)" ;;
esac

URGENT_VALUE=90

PREV_TOTAL=0
PREV_IDLE=0

cpuFile="/tmp/.cpu"

if [[ -f "${cpuFile}" ]]; then
  fileCont=$(cat "${cpuFile}")
  PREV_TOTAL=$(echo "${fileCont}" | head -n 1)
  PREV_IDLE=$(echo "${fileCont}" | tail -n 1)
fi

CPU=(`cat /proc/stat | grep '^cpu '`)
unset CPU[0]
IDLE=${CPU[4]}

TOTAL=0

for VALUE in "${CPU[@]:0:4}"; do
  let "TOTAL=$TOTAL+$VALUE"
done

if [[ "${PREV_TOTAL}" != "" ]] && [[ "${PREV_IDLE}" != "" ]]; then
  let "DIFF_IDLE=$IDLE-$PREV_IDLE"
  let "DIFF_TOTAL=$TOTAL-$PREV_TOTAL"
  let "DIFF_USAGE=(1000*($DIFF_TOTAL-$DIFF_IDLE)/$DIFF_TOTAL+5)/10"
  echo "${DIFF_USAGE}%"
  echo "${DIFF_USAGE}%"
  echo ""
else
  echo "?"
  echo "?"
  echo ""
fi

echo "${TOTAL}" > "${cpuFile}"
echo "${IDLE}" >> "${cpuFile}"

if [[ "${DIFF_USAGE}" -gt 0 ]] && [[ "${DIFF_USAGE}" -gt "${URGENT_VALUE}" ]]; then
  exit 33
fi
