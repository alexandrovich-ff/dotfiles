#!/bin/sh

# vim: filetype=dmenu
#  ____  __  __ _____ _   _ _   _       _   _ __  __  ___  _   _ _   _ _____ 
# |  _ \|  \/  | ____| \ | | | | |     | | | |  \/  |/ _ \| | | | \ | |_   _|
# | | | | |\/| |  _| |  \| | | | |_____| | | | |\/| | | | | | | |  \| | | |  
# | |_| | |  | | |___| |\  | |_| |_____| |_| | |  | | |_| | |_| | |\  | | |  
# |____/|_|  |_|_____|_| \_|\___/       \___/|_|  |_|\___/ \___/|_| \_| |_|  
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π
# –ù–∞–ø–∏—Å–∞–Ω: @alexandrovich.ff
# Website: http://malikov.red

unmountusb() {
	[ -z "$drives" ] && exit
	chosen=$(echo "$drives" | ::dmenu -x 15 -y 40 -h 28 -w 1000 -i -p "–ö–∞–∫–æ–π –¥–∏—Å–∫ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å?" | awk '{print $1}')
	[ -z "$chosen" ] && exit
        sudo -A umount "$chosen" && notify-send "üíª USB –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω" "$chosen —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ."
	}

unmountandroid() { \
	chosen=$(awk '/simple-mtpfs/ {print $2}' /etc/mtab | ::dmenu -x 15 -y 40 -h 28 -w 1000 -i -p "–ö–∞–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å?")
	[ -z "$chosen" ] && exit
        sudo -A umount -l "$chosen" && notify-send "ü§ñ Android –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω" "$chosen —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ."
	}

asktype() { \
	case "$(printf "USB\\nAndroid" | ::dmenu -x 15 -y 40 -h 28 -w 1000 -i -p "–†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å USB-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Android?")" in
		USB) unmountusb ;;
		Android) unmountandroid ;;
	esac
	}

drives=$(lsblk -nrpo "name,type,size,mountpoint" | awk '$2=="part"&&$4!~/\/boot|\/home$|SWAP/&&length($4)>1{printf "%s (%s)\n",$4,$3}')

if ! grep simple-mtpfs /etc/mtab; then
	[ -z "$drives" ] && echo "–ù–µ—Ç –¥–∏—Å–∫–æ–≤ –¥–ª—è —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è." &&  exit
	echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–π USB-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å."
	unmountusb
else
	if [ -z "$drives" ]
	then
		echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Android."
	       	unmountandroid
	else
		echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ USB-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏ –∏ Android-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞."
		asktype
	fi
fi
